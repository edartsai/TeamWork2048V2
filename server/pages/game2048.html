<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>

    <script src="js_lib/jquery.keyframes.min.js"></script>
    <script src="js/enum.js"></script>
    <script src="js/view.js"></script>
    <script src="js/utility.js"></script>
    <script src="js/iscando.js"></script>
    <script src="js/merge.js"></script>
    <script src="js/move.js"></script>
    <script src="js/main.js"></script>
    <link rel="stylesheet" href="css/game2048battlestyle.min.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
    <div id="fb-root"></div>
    <!--<script src="js/fb.js"></script>-->
<script>
    var socket = io();
    var isCanClick = true;
    var isAnimationComplete = true;
    var boxMoveTime = "100ms";

    //遊戲目前狀態
    var mapObj = {
        Size: 4,
        Items: [],
        IdMax: 0,
        Score: 0,
        IsGameOver: false
    };
    
    //遊戲上一狀態
    var prevObj = {
        Size: 4,
        Items: [],
        IdMax: 0,
        Score: 0,
        IsGameOver: false
    };

    var roomInfo = {
    	id: -1,
    	player: 0
    };

    $(document).ready(function () {
        document.onkeydown = keyFunction;

        //使用行動裝置
        InitMobile();

        initBattle();
    });

    function moveLeft() {
        if (Move(mapObj, DIRECTION.LEFT, prevObj)) {
            boxsmove(mapObj, prevObj);      //動畫+重繪數字
            EnableRollbackButton();         //「上一步」按鈕狀態控制
            sendMove(mapObj);               //send move obj to server
        }
    }

    function moveRight() {
        if (Move(mapObj, DIRECTION.RIGHT, prevObj)) {
            boxsmove(mapObj, prevObj);      //動畫+重繪數字
            EnableRollbackButton();         //「上一步」按鈕狀態控制
            sendMove(mapObj);               //send move obj to server
        }
    }

    function moveUp() {
        if (Move(mapObj, DIRECTION.UP, prevObj)) {
            boxsmove(mapObj, prevObj);      //動畫+重繪數字
            EnableRollbackButton();         //「上一步」按鈕狀態控制
            sendMove(mapObj);               //send move obj to server
        }
    }

    function moveDown() {
        if (Move(mapObj, DIRECTION.DOWN, prevObj)) {
            boxsmove(mapObj, prevObj);      //動畫+重繪數字
            EnableRollbackButton();         //「上一步」按鈕狀態控制
            sendMove(mapObj);               //send move obj to server
        }
    }

    function rollback() {
        Clone(prevObj, mapObj);     //將前一狀態倒回現在狀態
        sendMove(mapObj);           //send move obj to server

        MappingArrayData(mapObj);   //重繪Array
        HideGameOverMask();         //假如有 GameOver，則將 Mask 隱藏
        DisableRollbackButton();    //關閉「上一步」
    }

    function reset() {
        var size = 4;
        //createMitrixDiv(size);        //畫上 Grid
        Init(mapObj, size);             //Init Data
        Clone(mapObj, prevObj);         //紀錄狀態

        MappingArrayData(mapObj);       //重繪數字

        HideGameOverMask();             //關閉GameOver Mask
        DisableRollbackButton();        //關閉「上一步」
    }

    function keyFunction() {
        if (isCanSendKey()) {
            if (event.keyCode === 37 ) {
                moveLeft();
            } else if (event.keyCode === 38 ) {
                moveUp();
            } else if (event.keyCode === 39 ) {
                moveRight();
            } else if (event.keyCode === 40 ) {
                moveDown();
            }
        }
    }

    function InitMobile() {
        if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
            $.getScript('https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js', function() {
                $.getScript('js/initmobile.js', function() {
                    $.mobile.loading().hide();

                    $(document).on("swipeleft", function() {
                        moveLeft();
                    });

                    $(document).on("swiperight", function() {
                        moveRight();
                    });

                    $(document).on("swipeup", function() {
                        moveUp();
                    });
                    $(document).on("swipedown", function() {
                        moveDown();
                    });
                });
            });
        }
    }

    function initBattle() {
        isCanClick = false;     // 關閉 keycode 控制
        DisableResetButton();   // 關閉 Button
        DisableRollbackButton();// 關閉 Button
        DisableReadyButton();   // 關閉 Button

    	socket.emit('init_room');

        // server 回傳安排的 room & player
    	socket.on('init_room', function (result) {
            roomInfo.id = result.id;
            roomInfo.player = result.player;
        });

        // server 回傳 對手進入房間
        socket.on('init_room_opposite', function () {
            //todo:
            setMsg('Opposite is in room');
        });

        // server 回傳 滿房
        socket.on('init_room_full', function () {
            socket.emit('init_game', roomInfo);
        });

        // server 回傳 已可點擊 Ready btn
        socket.on('init_ready', function () {
            isCanClick = false;     // 關閉 keycode 控制
            DisableResetButton();   // 關閉 Button
            DisableRollbackButton();// 關閉 Button

            //unlock ready btn
            EnableReadyButton();
        });

        // 點擊送出 ready 
        $('#readybtn').click(function () {
            DisableReadyButton();
            reset();
            socket.emit('send_ready', { id: roomInfo.id, map: mapObj });
        });

        // server 回傳 對手 已ready
        socket.on('send_ready_opposite', function (oppoInitmap) {
            setMsg('opposite is ready');
            if (oppoInitmap !== undefined) {
                MappingArrayData_Oppo(oppoInitmap); 
            }
        });

        // server 回傳 第一階段倒數
        socket.on('send_countdown1', function (secs) {
            $('#gametimespan').text(ConvertSeconds2String(secs));
        });

        // server 回傳 第一階段倒數結束 (遊戲開始可操作)
        socket.on('send_countdown1_over', function () {
            isCanClick = true;      // 開啟 keycode 控制
            EnableResetButton();    // 開啟 Button
            EnableRollbackButton(); // 開啟 Button
        });

        // server 回傳 第二階段倒數
        socket.on('send_countdown2', function (secs) {
            if (secs === undefined)
                return;
            var ss = ConvertSeconds2String(secs);
            $('#gametimespan').text(ss);
        });

        // server 回傳 第二階段倒數
        socket.on('send_countdown2_over', function () {
            setMsg('Game Over!!');

            isCanClick = false;     // 關閉 keycode 控制
            DisableResetButton();   // 關閉 Button
            DisableRollbackButton();// 關閉 Button

            EnableReadyButton();
        });

        // server 回傳 比賽結果(game over)
        socket.on('send_winner', function (data) {
            if (data === undefined || data === null)
                return;
            
            if(data.winner !== 0)
                setMsg('winner is player' + data.winner + ' score:' + data.map[0].Score);
            else
                setMsg('game is tie ,score:' + data.map[0].Score);
        });

        // make a move
    	socket.on('send_map', function (oppoMap) {
    	    if (oppoMap !== undefined) {
    	        MappingArrayData_Oppo(oppoMap);
    	    }
    	});

        socket.on('disconnect_opposite', function() {
            setMsg('Opposite leaved');
        });

        // on nickname changed
        $('#player1-name').blur(function() {

            var nickename = $('#player1-name').val();
            socket.emit('send_nickname', { id: roomInfo.id, nickname: nickename });

        });

        // when oppo change nickname
        socket.on('send_nickname_opposite', function(data) {
            setNickname_Oppo(data.nickname);
        });
    }

    function sendMove(map) {
        socket.emit('send_map', { id: roomInfo.id, map: map });
    }

    function isCanSendKey() {
        return isCanClick && isAnimationComplete;
    }

</script>

<div class="main-contain" >

    <div class="mask-body" id="mask-body" style="visibility: collapse">
        <p style="font-size: 40px;">Game Over</p>
        <!--<button class="savescorebutton" onclick="openLeaderboard()">登入排行榜</button>-->
    </div>

    <h2>2048</h2>
    <p>第一對戰房</p>

    <div id="capture-range-div">

        <div>
            
            <div id="block1-detaildata" style="height: 55px">
                <!--倒數計時器-->
                <div id="timer-div">
                    <p id="gametimespan">00:00</p>
                </div>
                <!--分數-->
                <div id="player1-scare">
                    <p class="score-title">SCORE</p>
                    <p class="score-content" id="score">0</p>
                </div>
                <!--player 1-->
                <!--<div id="player1-name">-->
                    <input type="text" id="player1-name" size=2 placeholder="請輸入對戰暱稱" >
                
                
                <!--重玩-->
                <button class="back-button" id="resetbtn" type="submit" onclick="reset()" style="float:right">
                    <img src="images/b_brefresh_20_n.png" alt="" />
                </button>
                <!--上一步-->
                <button class="back-button" id="rollbackbtn" type="submit" onclick="rollback()" style="float:right">
                    <img src="images/b_back_btn_20_p.png" alt="" />
                </button>
            </div>

            <div id="play1divcss">
                

                <div id="play1-box-body">
                    <div class="box-row">
                        <div id="play1-box-column-border"></div>
                        <div id="play1-box-row-border"></div>
                        <div class='box'><p class='box-number'></p></div>
                        <div id="play1-box-row-border"></div>
                        <div class='box'><p class='box-number'></p></div>
                        <div id="play1-box-row-border"></div>
                        <div class='box'><p class='box-number'></p></div>
                        <div id="play1-box-row-border"></div>
                        <div class='box'><p class='box-number'></p></div>
                        <div id="play1-box-row-border"></div>
                    </div>
                    <div class='box-row'>
                        <div id="play1-box-column-border"></div>
                        <div id="play1-box-row-border"></div>
                        <div class='box'><p class='box-number'></p></div>
                        <div id="play1-box-row-border"></div>
                        <div class='box'><p class='box-number'></p></div>
                        <div id="play1-box-row-border"></div>
                        <div class='box'><p class='box-number'></p></div>
                        <div id="play1-box-row-border"></div>
                        <div class='box'><p class='box-number'></p></div>
                        <div id="play1-box-row-border"></div>
                    </div>
                    <div class='box-row'>
                        <div id="play1-box-column-border"></div>
                        <div id="play1-box-row-border"></div>
                        <div class='box'><p class='box-number'></p></div>
                        <div id="play1-box-row-border"></div>
                        <div class='box'><p class='box-number'></p></div>
                        <div id="play1-box-row-border"></div>
                        <div class='box'><p class='box-number'></p></div>
                        <div id="play1-box-row-border"></div>
                        <div class='box'><p class='box-number'></p></div>
                        <div id="play1-box-row-border"></div>
                    </div>
                    <div class='box-row'>
                        <div id="play1-box-column-border"></div>
                        <div id="play1-box-row-border"></div>
                        <div class='box'><p class='box-number'></p></div>
                        <div id="play1-box-row-border"></div>
                        <div class='box'><p class='box-number'></p></div>
                        <div id="play1-box-row-border"></div>
                        <div class='box'><p class='box-number'></p></div>
                        <div id="play1-box-row-border"></div>
                        <div class='box'><p class='box-number'></p></div>
                        <div id="play1-box-row-border"></div>
                    </div>
                    <div id="play1-box-column-border"></div>
                </div>

            </div>

            <div id="play2divcss">
                <div>
                    <!--分數-->
                    <div id="player2-scare">
                        <p class="score-title">SCORE</p>
                        <p class="score-content" id="score2">0</p>
                    </div>
                    <div id="player2-name">
                        <p id="player2-name-p">NAME</p>
                    </div>
                    <div style="clear:both;"></div>

                    <div id="play2-box-body">
                        <div class='box-row'>
                            <div id="play2-box-column-border"></div>
                            <div id="play2-box-row-border"></div>
                            <div class='box2'><p class='box2-number'></p></div>
                            <div id="play2-box-row-border"></div>
                            <div class='box2'><p class='box2-number'></p></div>
                            <div id="play2-box-row-border"></div>
                            <div class='box2'><p class='box2-number'></p></div>
                            <div id="play2-box-row-border"></div>
                            <div class='box2'><p class='box2-number'></p></div>
                            <div id="play2-box-row-border"></div>
                        </div>
                        <div class='box-row'>
                            <div id="play2-box-column-border"></div>
                            <div id="play2-box-row-border"></div>
                            <div class='box2'><p class='box2-number'></p></div>
                            <div id="play2-box-row-border"></div>
                            <div class='box2'><p class='box2-number'></p></div>
                            <div id="play2-box-row-border"></div>
                            <div class='box2'><p class='box2-number'></p></div>
                            <div id="play2-box-row-border"></div>
                            <div class='box2'><p class='box2-number'></p></div>
                            <div id="play2-box-row-border"></div>
                        </div>
                        <div class='box-row'>
                            <div id="play2-box-column-border"></div>
                            <div id="play2-box-row-border"></div>
                            <div class='box2'><p class='box2-number'></p></div>
                            <div id="play2-box-row-border"></div>
                            <div class='box2'><p class='box2-number'></p></div>
                            <div id="play2-box-row-border"></div>
                            <div class='box2'><p class='box2-number'></p></div>
                            <div id="play2-box-row-border"></div>
                            <div class='box2'><p class='box2-number'></p></div>
                            <div id="play2-box-row-border"></div>
                        </div>
                        <div class='box-row'>
                            <div id="play2-box-column-border"></div>
                            <div id="play2-box-row-border"></div>
                            <div class='box2'><p class='box2-number'></p></div>
                            <div id="play2-box-row-border"></div>
                            <div class='box2'><p class='box2-number'></p></div>
                            <div id="play2-box-row-border"></div>
                            <div class='box2'><p class='box2-number'></p></div>
                            <div id="play2-box-row-border"></div>
                            <div class='box2'><p class='box2-number'></p></div>
                            <div id="play2-box-row-border"></div>
                        </div>
                        <div id="play2-box-column-border"></div>
                    </div>

                </div>
            </div>

            
        </div>
    </div>

    <div style="height:50px">
        <span id="gamemsgspan" ></span>
        <input id="readybtn" type="button" value="READY"/>
    </div>
    

</div>


<!--<div id="developing-div">
	<br/>
	<span> DEVELOPING </span> <br/>
	
    <div>
        <span id="gametimespan" ></span>
    </div>
    <div>
        <span id="gamemsgspan"></span>
    </div>
    <div>
        <input type="button" id="readybtn" value="ready"/>
    </div>
</div>-->

</body>

</html>